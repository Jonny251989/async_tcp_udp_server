name: Async TCP/UDP Server CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: docker pull jonnyrembo/async-tcp-udp-server:latest

      - name: Run unit tests
        run: |
          docker run --rm jonnyrembo/async-tcp-udp-server:latest ./build/unit_tests

      - name: Prepare test data
        run: |
          mkdir -p tests/test_data
          echo "Hello World" > tests/test_data/echo_tcp_input.txt
          echo "/time" > tests/test_data/time_tcp_input.txt
          echo "/stats" > tests/test_data/stats_tcp_input.txt
          echo "Hello UDP" > tests/test_data/echo_udp_input.txt
          echo "/time" > tests/test_data/time_udp_input.txt

      - name: Run functional tests
        run: |
          # Создаем сеть
          docker network create test-net
          
          # Запускаем сервер
          docker run -d --name server --network test-net \
            -p 8080:8080 -p 8080:8080/udp \
            jonnyrembo/async-tcp-udp-server:latest ./build/telemetry_server 8080
          
          # Ждем запуска сервера
          sleep 10
          
          # Запускаем функциональные тесты
          docker run --rm --network test-net \
            -v $(pwd)/tests/test_data:/workspace/tests/test_data:ro \
            -e SERVER_HOST=server -e SERVER_PORT=8080 \
            jonnyrembo/async-tcp-udp-server:latest ./build/functional_tests
          
          # Очистка
          docker stop server
          docker rm server
          docker network rm test-net