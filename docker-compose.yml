version: "3.8"

services:
  test:
    image: async-test-runner
    container_name: async-tests-test
    command: >
      bash -c "
        make unit-test &&
        echo '---' &&
        make functional-test
      "
    volumes:
      - .:/workspace
    working_dir: /workspace
    network_mode: host

  systemd-test:
    image: async-test-runner
    container_name: async-tests-systemd
    command: >
      bash -c "
        echo '=== Systemd Test ===' &&
        ls -la /etc/systemd/system/async-server.service &&
        echo '---' &&
        cat /etc/systemd/system/async-server.service &&
        echo '---' &&
        ls -la /usr/bin/async_tcp_udp_server &&
        echo '---' &&
        id async-server &&
        echo '---' &&
        /usr/bin/async_tcp_udp_server 8081 &
        SERVER_PID=$$! &&
        sleep 3 &&
        echo 'STATS' | timeout 2 nc -N localhost 8081 || true &&
        echo '/shutdown' | timeout 2 nc -N localhost 8081 || true &&
        wait $$SERVER_PID
      "
    volumes:
      - .:/workspace
    working_dir: /workspace
    network_mode: host