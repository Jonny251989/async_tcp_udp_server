version: '3.8'

networks:
  async_tcp_udp_net:
    driver: bridge

services:
  async_tcp_udp_server:
    build:
      context: .
      dockerfile: Dockerfile.simple
    container_name: async_tcp_udp_server
    ports:
      - "8081:8080/tcp"
      - "8081:8080/udp"
    networks:
      - async_tcp_udp_net
    healthcheck:
      test: ["CMD", "pgrep", "async_tcp_udp_server"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s


  systemd_tests:
    build:
      context: .
      dockerfile: Dockerfile.simple
    container_name: systemd_tests
    working_dir: /workspace
    networks:
      - async_tcp_udp_net
    command: 
      - /bin/bash
      - -c
      - |
        echo "=== Waiting for server to start ==="
        sleep 10
        
        SERVER_IP=$$(getent hosts async_tcp_udp_server | awk '{ print $$1 }')
        echo "Testing server at $$SERVER_IP:8080"
        
        echo "=== Checking if server is accessible ==="
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$$SERVER_IP/8080"; then
          echo "TCP port 8080 is accessible!"
        else
          echo "TCP port 8080 is NOT accessible"
          echo "Trying to check container status..."
          docker-compose logs async_tcp_udp_server
          exit 1
        fi
        
        echo "=== Testing TCP commands ==="
        echo "1. Testing /time command:"
        echo -e "/time\nquit" | timeout 5 /usr/local/bin/async_client tcp $$SERVER_IP 8080 2>&1 || echo "Time command test completed"
        
        echo "2. Testing /stats command:"
        echo -e "/stats\nquit" | timeout 5 /usr/local/bin/async_client tcp $$SERVER_IP 8080 2>&1 || echo "Stats command test completed"
        
        echo "=== Testing UDP commands ==="
        echo "3. Testing UDP /time command:"
        echo -e "/time\nquit" | timeout 5 /usr/local/bin/async_client udp $$SERVER_IP 8080 2>&1 || echo "UDP Time command test completed"
        
        echo "=== Tests completed ==="
    depends_on:
      - async_tcp_udp_server