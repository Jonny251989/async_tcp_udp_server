version: "3.8"

services:
  test:
    image: jonnyrembo/async-tcp-udp-server:latest
    container_name: async-tests-test
    command: >
      bash -c "
        make unit-test &&
        echo '---' &&
        # Создаем симлинк для клиента если нужно
        if [ ! -f /workspace/build/client_app ] && [ -f /usr/bin/client_app ]; then
          mkdir -p /workspace/build
          ln -sf /usr/bin/client_app /workspace/build/client_app
        fi &&
        make functional-test
      "
    volumes:
      - .:/workspace
    working_dir: /workspace
    network_mode: host

  systemd-test:
    image: jonnyrembo/async-tcp-udp-server:latest
    container_name: async-tests-systemd
    command: >
      bash -c "
        echo '=== Systemd Test ===' &&
        ls -la /etc/systemd/system/async-server.service &&
        echo '---' &&
        cat /etc/systemd/system/async-server.service &&
        echo '---' &&
        ls -la /usr/bin/async_tcp_udp_server &&
        echo '---' &&
        id async-server &&
        echo '---' &&
        /usr/bin/async_tcp_udp_server 8080 &
        SERVER_PID=$$! &&
        sleep 3 &&
        echo 'STATS' | timeout 2 nc -N localhost 8080 || true &&
        echo '/shutdown' | timeout 2 nc -N localhost 8080 || true &&
        wait $$SERVER_PID
      "
    volumes:
      - .:/workspace
    working_dir: /workspace
    network_mode: host